name: PR Build & Test

on:
  pull_request:
    branches: [main, master]

jobs:
  build-windows:
    name: Build & Test Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.1"
          arch: "win64_msvc2022_64"
        id: install-qt

      - name: Set Qt directory
        shell: pwsh
        run: |
          $QtDir = $null
          if ($env:Qt6_DIR) {
            $QtDir = $env:Qt6_DIR
          } elseif ($env:Qt_DIR) {
            $QtDir = $env:Qt_DIR
          } else {
            $QtConfig = Get-ChildItem -Path "$env:RUNNER_WORKSPACE" -Filter "Qt6Config.cmake" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($QtConfig) {
              $QtDir = $QtConfig.Directory.Parent.Parent.Parent.FullName
            }
          }

          if (-not $QtDir -or -not (Test-Path $QtDir)) {
            Write-Host "Error: Could not determine Qt directory"
            exit 1
          }

          Write-Host "Using Qt directory: $QtDir"
          echo "QT_DIR=$QtDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v1.1

      - name: Configure CMake
        shell: pwsh
        run: |
          $cmakeArgs = @("-B", "build", "-G", "Visual Studio 17 2022", "-A", "x64")
          cmake @cmakeArgs
        env:
          CMAKE_PREFIX_PATH: ${{ env.QT_DIR }}

      - name: Build
        run: |
          cmake --build build --config Release

      - name: Run Tests
        run: |
          .\build\Release\txd_tests.exe --gtest_color=yes

      - name: Deploy Qt libraries
        run: |
          $QtBinPath = "$env:QT_DIR\bin"
          $ExePath = "build\bin\Release\txdedit.exe"

          if (-not (Test-Path $QtBinPath)) {
            Write-Host "Error: Qt bin directory not found at $QtBinPath"
            exit 1
          }

          if (-not (Test-Path $ExePath)) {
            Write-Host "Error: Executable not found at $ExePath"
            exit 1
          }

          $Windeployqt = "$QtBinPath\windeployqt.exe"
          if (Test-Path $Windeployqt) {
            Write-Host "Using windeployqt to deploy Qt libraries..."
            & $Windeployqt --release --compiler-runtime --force $ExePath
          } else {
            Write-Host "Warning: windeployqt not found, manually copying DLLs..."
            $DestPath = "build\bin\Release"
            $PlatformsPath = "$DestPath\platforms"
            if (-not (Test-Path $PlatformsPath)) {
              New-Item -ItemType Directory -Force -Path $PlatformsPath | Out-Null
            }
            $QtDlls = @("Qt6Core.dll", "Qt6Gui.dll", "Qt6Widgets.dll")
            foreach ($dll in $QtDlls) {
              $src = "$QtBinPath\$dll"
              if (Test-Path $src) {
                Copy-Item $src -Destination $DestPath -Force
              }
            }
            $PlatformDll = "$QtBinPath\platforms\qwindows.dll"
            if (Test-Path $PlatformDll) {
              Copy-Item $PlatformDll -Destination $PlatformsPath -Force
            }
          }

      - name: Create Windows ZIP
        run: |
          if (Test-Path "build\bin\icons") {
            Copy-Item -Path "build\bin\icons" -Destination "build\bin\Release\icons" -Recurse -Force
          }
          if (Test-Path "build\bin\logos") {
            Copy-Item -Path "build\bin\logos" -Destination "build\bin\Release\logos" -Recurse -Force
          }
          Compress-Archive -Path "build\bin\Release\*" -DestinationPath "txdedit-windows-x64.zip" -Force

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: txdedit-windows-x64
          path: txdedit-windows-x64.zip
          retention-days: 7

  build-linux:
    name: Build & Test Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libgl1-mesa-dev

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.1"
        id: install-qt

      - name: Set Qt directory
        run: |
          QT_DIR=""
          if [ -n "${{ env.Qt6_DIR }}" ]; then
            QT_DIR="${{ env.Qt6_DIR }}"
          elif [ -n "${{ env.Qt_DIR }}" ]; then
            QT_DIR="${{ env.Qt_DIR }}"
          else
            QT_CONFIG=$(find "$HOME" "$RUNNER_WORKSPACE" -name "Qt6Config.cmake" -type f 2>/dev/null | head -1)
            if [ -n "$QT_CONFIG" ]; then
              QT_DIR=$(dirname "$QT_CONFIG" | xargs dirname | xargs dirname | xargs dirname)
            fi
          fi

          if [ -z "$QT_DIR" ] || [ ! -d "$QT_DIR" ]; then
            echo "Error: Could not determine Qt directory"
            exit 1
          fi

          echo "Using Qt directory: $QT_DIR"
          echo "QT_DIR=$QT_DIR" >> $GITHUB_ENV

      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${{ env.QT_DIR }}"

      - name: Build
        run: |
          cmake --build build --config Release -j$(nproc)

      - name: Run Tests
        run: |
          ./build/txd_tests --gtest_color=yes

      - name: Install linuxdeploy
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

      - name: Install Qt plugin
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy-plugin-qt-x86_64.AppImage

      - name: Create AppDir
        run: |
          mkdir -p AppDir/usr/bin
          cp build/bin/txdedit AppDir/usr/bin/
          cp -r build/bin/icons AppDir/usr/bin/
          cp -r build/bin/logos AppDir/usr/bin/

          if [ -f "build/bin/icons/linux.png" ]; then
            mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
            cp build/bin/icons/linux.png AppDir/usr/share/icons/hicolor/256x256/apps/txdedit.png
            mkdir -p AppDir/usr/share/icons/hicolor/128x128/apps
            mkdir -p AppDir/usr/share/icons/hicolor/64x64/apps
            mkdir -p AppDir/usr/share/icons/hicolor/48x48/apps
            mkdir -p AppDir/usr/share/icons/hicolor/32x32/apps
            cp build/bin/icons/linux.png AppDir/usr/share/icons/hicolor/128x128/apps/txdedit.png
            cp build/bin/icons/linux.png AppDir/usr/share/icons/hicolor/64x64/apps/txdedit.png
            cp build/bin/icons/linux.png AppDir/usr/share/icons/hicolor/48x48/apps/txdedit.png
            cp build/bin/icons/linux.png AppDir/usr/share/icons/hicolor/32x32/apps/txdedit.png
          fi

      - name: Create AppImage
        run: |
          export PATH="${{ env.QT_DIR }}/bin:$PATH"
          export LD_LIBRARY_PATH="${{ env.QT_DIR }}/lib:$LD_LIBRARY_PATH"
          export QMAKE="${{ env.QT_DIR }}/bin/qmake"

          if [ ! -f "$QMAKE" ]; then
            echo "Error: qmake not found at $QMAKE"
            exit 1
          fi

          chmod +x "$QMAKE"

          mkdir -p AppDir/usr/share/applications
          cat > AppDir/usr/share/applications/txdedit.desktop << 'DESKTOP_EOF'
          [Desktop Entry]
          Type=Application
          Name=TXD Edit
          Exec=txdedit
          Icon=txdedit
          Comment=View and edit TXD (Texture Dictionary) files from GTA games
          Categories=Graphics;
          DESKTOP_EOF

          QMAKE="$QMAKE" ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --plugin qt \
            --output appimage || true

          APPIMAGE_FILE=""
          for file in *.AppImage; do
            if [ -f "$file" ] && [ "$file" != "linuxdeploy-x86_64.AppImage" ] && [ "$file" != "linuxdeploy-plugin-qt-x86_64.AppImage" ]; then
              APPIMAGE_FILE="$file"
              break
            fi
          done

          if [ -n "$APPIMAGE_FILE" ] && [ -f "$APPIMAGE_FILE" ]; then
            mv "$APPIMAGE_FILE" txdedit-linux-x86_64.AppImage
            chmod +x txdedit-linux-x86_64.AppImage
          else
            echo "Creating fallback AppImage without qt plugin..."
            ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage || true
            
            for file in *.AppImage; do
              if [ -f "$file" ] && [ "$file" != "linuxdeploy-x86_64.AppImage" ] && [ "$file" != "linuxdeploy-plugin-qt-x86_64.AppImage" ]; then
                APPIMAGE_FILE="$file"
                break
              fi
            done
            
            if [ -n "$APPIMAGE_FILE" ] && [ -f "$APPIMAGE_FILE" ]; then
              mv "$APPIMAGE_FILE" txdedit-linux-x86_64.AppImage
              chmod +x txdedit-linux-x86_64.AppImage
            else
              echo "Error: Failed to create AppImage"
              exit 1
            fi
          fi

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: txdedit-linux-x86_64
          path: txdedit-linux-x86_64.AppImage
          retention-days: 7

  build-macos:
    name: Build & Test macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.1"
          arch: "clang_64"
        id: install-qt

      - name: Set Qt directory
        run: |
          QT_DIR=""

          if [ -n "${{ env.Qt6_DIR }}" ]; then
            QT_DIR="${{ env.Qt6_DIR }}"
          elif [ -n "${{ env.Qt_DIR }}" ]; then
            QT_DIR="${{ env.Qt_DIR }}"
          fi

          if [ -z "$QT_DIR" ] && [ -n "${{ steps.install-qt.outputs.Qt6_DIR }}" ]; then
            QT_DIR="${{ steps.install-qt.outputs.Qt6_DIR }}"
          fi

          if [ -z "$QT_DIR" ] || [ ! -d "$QT_DIR" ]; then
            POSSIBLE_PATHS=(
              "$HOME/Qt/6.10.1/clang_64"
              "/Users/runner/Qt/6.10.1/clang_64"
              "$RUNNER_WORKSPACE/Qt/6.10.1/clang_64"
            )
            
            for path in "${POSSIBLE_PATHS[@]}"; do
              if [ -d "$path" ] && [ -f "$path/bin/qmake" ]; then
                QT_DIR="$path"
                break
              fi
            done
            
            if [ -z "$QT_DIR" ] || [ ! -d "$QT_DIR" ]; then
              QT_CONFIG=$(find "$HOME" "$RUNNER_WORKSPACE" "/Users/runner" -name "Qt6Config.cmake" -type f 2>/dev/null | head -1)
              if [ -n "$QT_CONFIG" ]; then
                QT_DIR=$(dirname "$QT_CONFIG" | xargs dirname | xargs dirname | xargs dirname)
              fi
            fi
          fi

          if [ -z "$QT_DIR" ] || [ ! -d "$QT_DIR" ]; then
            echo "Error: Could not determine Qt directory"
            exit 1
          fi

          if [ ! -f "$QT_DIR/bin/qmake" ]; then
            echo "Error: qmake not found at $QT_DIR/bin/qmake"
            exit 1
          fi

          echo "Using Qt directory: $QT_DIR"
          echo "QT_DIR=$QT_DIR" >> $GITHUB_ENV

      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${{ env.QT_DIR }}"

      - name: Build
        run: |
          cmake --build build --config Release -j$(sysctl -n hw.ncpu)

      - name: Run Tests
        run: |
          ./build/txd_tests --gtest_color=yes

      - name: Deploy Qt frameworks
        run: |
          QT_DIR="${{ env.QT_DIR }}"
          export PATH="$QT_DIR/bin:$PATH"

          MACDEPLOYQT="$QT_DIR/bin/macdeployqt"

          if [ ! -f "$MACDEPLOYQT" ]; then
            MACDEPLOYQT=$(find "$QT_DIR" -name "macdeployqt" -type f 2>/dev/null | head -1)
          fi

          if [ -z "$MACDEPLOYQT" ] || [ ! -f "$MACDEPLOYQT" ]; then
            echo "Error: macdeployqt not found"
            exit 1
          fi

          chmod +x "$MACDEPLOYQT"
          "$MACDEPLOYQT" build/bin/txdedit.app -always-overwrite

      - name: Install create-dmg
        run: |
          brew install create-dmg

      - name: Create DMG
        run: |
          APP_PATH="build/bin/txdedit.app"
          DMG_NAME="txdedit-macos-x64.dmg"
          DMG_APP_NAME="TXD Edit.app"

          xattr -cr "$APP_PATH"

          codesign --force --deep --sign - "$APP_PATH" || true

          mkdir -p dmg_temp
          cp -R "$APP_PATH" "dmg_temp/$DMG_APP_NAME"

          xattr -cr "dmg_temp/$DMG_APP_NAME"
          codesign --force --deep --sign - "dmg_temp/$DMG_APP_NAME" || true

          create-dmg \
            --volname "TXD Edit" \
            --volicon "$APP_PATH/Contents/Resources/mac.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "$DMG_APP_NAME" 150 190 \
            --hide-extension "$DMG_APP_NAME" \
            --app-drop-link 450 190 \
            "$DMG_NAME" \
            dmg_temp/

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: txdedit-macos-x64
          path: txdedit-macos-x64.dmg
          retention-days: 7
